<?php
ini_set('display_errors', 1);

error_reporting(E_ALL);
/* Si indica allo script di non uscire mentre attende una connessione */
set_time_limit(0);
/* Abilita lo scarico dell'output così si è in grado di vedere cosa passa
 * non appena arrivano i dati al server. */
ob_implicit_flush();

// settaggio variabili, il server ascolta sul proprio indirizzo ip  
$host = "192.168.1.17";
$port = 5001;

// setta timeout!
set_time_limit(1110);
// crea socket
$socket = socket_create(AF_INET, SOCK_STREAM, 0); // or die("Creazione socket fallita\n");
// Lega il socket alla porta $port sul server $host 
$result = socket_bind($socket, $host, $port); //or die("Fallito inizializzazione porta su socket\n");
// Inizio ascolto sulla connessione
$result = socket_listen($socket, 3); //or die("Start ascolto socket fallito\n");
// Accetta Connessioni
// Attende l'arrivo di una connessione client
$spawn = socket_accept($socket); //or die("Inizializzazione connessione con client fallita\n");
// Legge Client input
//$input = socket_read($spawn, 1024) or die("Errore Non riesco a leggere l'input\n");
$fp = fopen("file.obj", "a+");
file_put_contents("file.obj", "");
while(true){
	echo "legge l'obj ";
	$input = socket_read($spawn, 1024); //or die("Errore Non riesco a leggere l'input\n");
	fwrite($fp, $input);
	//echo $input;
    if( $input == false) {
	echo "non legge più l'obj ";
		break;
 	}
	}
	

//$a = substr_replace($input ,"", -1);

//$file = 'index.txt';
//file_put_contents($file, $input);

//Chiudi sockets
socket_close($spawn);
socket_close($socket);


 ?>
